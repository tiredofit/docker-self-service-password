#!/usr/bin/with-contenv bash

### Set Defaults
AD_OPT_CHANGE_EXPIRED_PASSWORD=${AD_OPT_CHANGE_EXPIRED_PASSWORD:-false}
AD_OPT_FORCE_PWD_CHANGE=${AD_OPT_FORCE_PWD_CHANGE:-false}
AD_OPT_FORCE_UNLOCK=${AD_OPT_FORCE_UNLOCK:-false}
ADMODE=${ADMODE:-false}
BACKGROUND=${BACKGROUND:-"images/unsplash-space.jpeg"}
CHANGE_PASSWORD=${CHANGE_PASSWORD:-true}
CHANGE_SSHKEY=${CHANGE_SSHKEY:-"false"}
DEBUG_MODE=${DEBUG_MODE:-false}
DEFAULT_ACTION=${DEFAULT_ACTION:-"change"}
ENABLE_RESET_LOG=${ENABLE_RESET_LOG:-false}
IS_BEHIND_PROXY=${IS_BEHIND_PROXY:-false}
LANG=${LANG:-"en"}
LANG_ALLOWED=${LANG_ALLOWED:-""}
LDAP_ANSWER_ATTRIBUTE=${LDAP_ANSWER_ATTRIBUTE:-"info"}
LDAP_BASE_SEARCH=${LDAP_BASE_SEARCH:-}
LDAP_BINDDN=${LDAP_BINDDN:-}
LDAP_BINDPASS=${LDAP_BINDPASS:-}
LDAP_EXTENDED_ERROR=${LDAP_EXTENDED_ERROR:-false}
LDAP_FILTER=${LDAP_FILTER:-"(\&(objectClass=person)(\$ldap_login_attribute={login}))"}
LDAP_FULLNAME_ATTRIBUTE=${LDAP_FULLNAME_ATTRIBUTE:-"cn"}
LDAP_LOGIN_ATTRIBUTE=${LDAP_LOGIN_ATTRIBUTE:-"uid"}
LDAP_MAIL_ATTRIBUTE=${LDAP_MAIL_ATTRIBUTE:-"mail"}
LDAP_SMS_ATTRIBUTE=${LDAP_SMS_ATTRIBUTE:-"mobile"}
LDAP_SSHKEY_ATTRIBUTE=${LDAP_SSHKEY_ATTRIBUTE:-"sshPublicKey"}
LDAP_STARTTLS=${LDAP_STARTTLS:-false}
LOG_LOCATION=${LOG_LOCATION:-"/www/logs/self-service-password/"}
LOG_RESET=${LOG_RESET:-"reset.log"}
LOGIN_FORBIDDEN_CHARACTERS=${LOGIN_FORBIDDEN_CHARACTERS:-"*()\&\|"}
LOGO=${LOGO:-"images/ltb-logo.png"}
MAIL_CHARSET=${MAIL_CHARSET:-"utf-8"}
MAIL_CONTENTTYPE=${MAIL_CONTENTTYPE:-"text/plain"}
MAIL_FROM=${MAIL_FROM:-"admin@example.com"}
MAIL_FROM_NAME=${MAIL_FROM_NAME:-"SelfService Password"}
MAIL_NEWLINE=${MAIL_NEWLINE:-"PHP_EOL"}
MAIL_PRIORITY=${MAIL_PRIORITY:-3}
MAIL_SIGNATURE=${MAIL_SIGNATURE:-""}
MAIL_USE_LDAP=${MAIL_USE_LDAP:-"false"}
MAIL_WORDWRAP=${MAIL_WORDWRAP:-0}
NOTIFY_ON_CHANGE=${NOTIFY_ON_CHANGE:-false}
NOTIFY_ON_SSHKEY_CHANGE=${NOTIFY_ON_SSHKEY_CHANGE:-true}
PASSWORD_COMPLEXITY=${PASSWORD_COMPLEXITY:-0}
PASSWORD_DIFFERENT_LOGIN=${PASSWORD_DIFFERENT_LOGIN:-"true"}
PASSWORD_HASH=${PASSWORD_HASH:-"auto"}
PASSWORD_HASH_CRYPT_SALT_LENGTH=${PASSWORD_HASH_CRYPT_SALT_LENGTH:-6}
PASSWORD_HASH_CRYPT_SALT_PREFIX=${PASSWORD_HASH_CRYPT_SALT_PREFIX:-"\$6\$"}
PASSWORD_MAX_LENGTH=${PASSWORD_MAX_LENGTH:-0}
PASSWORD_MIN_DIGIT=${PASSWORD_MIN_DIGIT:-0}
PASSWORD_MIN_LENGTH=${PASSWORD_MIN_LENGTH:-0}
PASSWORD_MIN_LOWERCASE=${PASSWORD_MIN_LOWERCASE:-0}
PASSWORD_MIN_SPECIAL=${PASSWORD_MIN_SPECIAL:-0}
PASSWORD_MIN_UPPERCASE=${PASSWORD_MIN_UPPERCASE:-0}
PASSWORD_NO_REUSE=${PASSWORD_NO_REUSE:-true}
PASSWORD_NO_SPECIAL_ENDS=${PASSWORD_NO_SPECIAL_ENDS:-false}
PASSWORD_SHOW_POLICY=${PASSWORD_SHOW_POLICY:-"never"}
PASSWORD_SHOW_POLICY_POSITION=${PASSWORD_SHOW_POLICY_POSITION:-"above"}
PASSWORD_SPECIAL_CHARACTERS=${PASSWORD_SPECIAL_CHARACTERS:-"^a-zA-Z0-9"}
PASSWORD_USE_PWNED=${PASSWORD_USE_PWNED:-false}
QUESTIONS_ANSWER_CRYPT=${QUESTIONS_ANSWER_CRYPT:-true}
QUESTIONS_ANSWER_OBJECTCLASS=${QUESTIONS_ANSWER_OBJECTCLASS:-"extensibleObject"}
QUESTIONS_MULTIPLE_ANSWERS=${QUESTIONS_MULTIPLE_ANSWERS:-false}
RECAPTCHA_PRIV_KEY=${RECAPTCHA_PRIV_KEY:-}
RECAPTCHA_PUB_KEY=${RECAPTCHA_PUB_KEY:-}
RECAPTCHA_REQUEST_METHOD=${RECAPTCHA_REQUEST_METHOD:-null}
RECAPTCHA_SIZE=${RECAPTCHA_SIZE:-"normal"}
RECAPTCHA_THEME=${RECAPTCHA_THEME:-"light"}
RECAPTCHA_TYPE=${RECAPTCHA_TYPE:-"image"}
SAMBA_EXPIRE_DAYS=${SAMBA_EXPIRE_DAYS:-90}
SAMBA_MAX_AGE=${SAMBA_MAX_AGE:-45}
SAMBA_MIN_AGE=${SAMBA_MIN_AGE:-5}
SAMBA_MODE=${SAMBA_MODE:-false}
SECRETKEY=${SECRETKEY:-"docker-selfservicepassword-change"}
SETUP_TYPE=${SETUP_TYPE:-"AUTO"}
SHADOW_OPT_UPDATE_SHADOWEXPIRE=${SHADOW_OPT_UPDATE_SHADOWEXPIRE:-false}
SHADOW_OPT_UPDATE_SHADOWLASTCHANGE=${SHADOW_OPT_UPDATE_SHADOWLASTCHANGE:-false}
SHOW_HELP=${SHOW_HELP:-true}
SHOW_MENU=${SHOW_MENU:-true}
SKIP_MAIL=${SKIP_MAIL:-"false"}
SMS_API_LIB=${SMS_API_LIB:-"lib/smsapi.inc.php"}
SMS_MAIL_SUBJECT=${SMS_MAIL_SUBJECT:-"Provider Code"}
SMS_MAIL_TO=${SMS_MAIL_TO:-"{sms_attribute}@service.provider.com"}
SMS_MESSAGE=${SMS_MESSAGE:-"{smsresetmessage} {smstoken}"}
SMS_METHOD=${SMS_METHOD:-"mail"}
SMS_PARTIAL_HIDE_NUMBER=${SMS_PARTIAL_HIDE_NUMBER:-true}
SMS_SANITIZE_NUMBER=${SMS_SANITIZE_NUMBER:-false}
SMS_TOKEN_LENGTH=${SMS_TOKEN_LENGTH:-6}
SMS_TOKEN_MAX_ATTEMPTS=${SMS_TOKEN_MAX_ATTEMPTS:-3}
SMS_TRUNCATE_NUMBER=${SMS_TRUNCATE_NUMBER:-false}
SMS_TRUNCATE_NUMBER_LENGTH=${SMS_TRUNCATE_NUMBER_LENGTH:-10}
SMTP_AUTH_ON=${SMTP_AUTH_ON:-false}
SMTP_AUTOTLS=${SMTP_AUTOTLS:-false}
SMTP_DEBUG=${SMTP_DEBUG:-0}
SMTP_HOST=${SMTP_HOST:-}
SMTP_KEEPALIVE=${SMTP_KEEPALIVE:-false}
SMTP_PASS=${SMTP_PASS:-}
SMTP_PORT=${SMTP_PORT:-587}
SMTP_SECURE_TYPE=${SMTP_SECURE_TYPE:-tls}
SMTP_TIMEOUT=${SMTP_TIMEOUT:-30}
SMTP_USER=${SMTP_USER:-}
TOKEN_CRYPT=${TOKEN_CRYPT:-true}
TOKEN_LIFETIME=${TOKEN_LIFETIME:-3600}
USE_PWNEDPASSWORDS=${USE_PWNEDPASSWORDS:-false}
USE_QUESTIONS=${USE_QUESTIONS:-false}
USE_RECAPTCHA=${USE_RECAPTCHA:-false}
USE_SMS=${USE_SMS:-false}
USE_TOKENS=${USE_TOKENS:-true}
WHO_CAN_CHANGE_PASSWORD=${WHO_CAN_CHANGE_PASSWORD:-"user"}
WHO_CAN_CHANGE_SSHKEY=${WHO_CAN_CHANGE_SSHKEY:-"user"}

update_config() {
    print_debug "Updating '\$${1}' with value '${2}"
    sed -i -e "s#\$${1} = .*#\$${1} = \"${2}\";#g" ${NGINX_WEBROOT}/conf/config.inc.php
}

update_config_noquote() {
    print_debug "Updating \$${1} with value '${2}"
    sed -i -e "s#${1} = .*#${1} = ${2};#g" ${NGINX_WEBROOT}/conf/config.inc.php
}
